generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ArInternalMetadata {
  key        String  @id
  value      String?
  created_at DateTime
  updated_at DateTime

  @@map("ar_internal_metadata")
}

model SchemaMigration {
  version String @id

  @@map("schema_migrations")
}

model Category {
  id            BigInt        @id @default(autoincrement())
  name          String?
  image_url     String?
  description   String?
  created_at    DateTime       @default(now())
  updated_at    DateTime       @updatedAt
  deleted_at    DateTime?

  // relations
  sub_categories SubCategory[]
  products       Product[]
  filter_options FilterOption[]

  @@map("categories")
}

model SubCategory {
  id          BigInt     @id @default(autoincrement())
  name        String?
  image_url   String?
  description String?
  category_id BigInt
  created_at  DateTime    @default(now())
  updated_at  DateTime    @updatedAt
  deleted_at  DateTime?

  // relations
  category Category  @relation(fields: [category_id], references: [id])
  products Product[]

  @@map("sub_categories")
}

model Product {
  id              BigInt    @id @default(autoincrement())
  name            String
  price           Decimal   @db.Decimal(10, 2)
  discount        Decimal   @db.Decimal(10, 2) @default(0.0)
  quantity        Int       @default(0)
  sold            Int       @default(0)
  img             String[]  @db.Text
  specs           Json      @default("[]")
  specs_detail    Json      @default("[]")
  color           Json      @default("[]")
  category_id     BigInt
  sub_category_id BigInt?
  rating          Decimal?  @db.Decimal(3, 2)
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  deleted_at      DateTime?

  // relations
  category     Category     @relation(fields: [category_id], references: [id])
  sub_category SubCategory? @relation(fields: [sub_category_id], references: [id])
  reviews      Review[]
  order_items  OrderItem[]
  cart_items   CartItem[]
  wishlists    Wishlist[]

  @@map("products")
  @@index([name])
  @@index([category_id])
  @@index([sub_category_id])
  @@index([price])
  @@index([rating])
}

model ProductSpec {
  id         BigInt   @id @default(autoincrement())
  label      String?
  value      Json?    @default("[]")
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  deleted_at DateTime?

  @@map("product_specs")
}

model User {
  id              BigInt   @id @default(autoincrement())
  name            String?
  email           String?  @unique
  password_digest String?
  role            String?  @default("user")
  phone           String?
  address         String?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
  deleted_at      DateTime?

  // relations
  orders    Order[]
  reviews   Review[]
  carts     Cart[]
  wishlists Wishlist[]
  coupons   Coupon[] @relation("UserCoupons")

  @@map("users")
}

model Cart {
  id         BigInt   @id @default(autoincrement())
  user_id    BigInt
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  deleted_at DateTime?

  // relations
  user       User       @relation(fields: [user_id], references: [id])
  cart_items CartItem[]

  @@map("carts")
}

model CartItem {
  id         BigInt   @id @default(autoincrement())
  cart_id    BigInt
  product_id BigInt
  quantity   Int      @default(1)
  color      Json
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  deleted_at DateTime?

  // relations
  cart    Cart    @relation(fields: [cart_id], references: [id])
  product Product @relation(fields: [product_id], references: [id])

  @@map("cart_items")
}

model Order {
  id               BigInt   @id @default(autoincrement())
  user_id          BigInt
  order_number     String?  @unique
  total_amount     Decimal? @db.Decimal(10, 2)
  status           String?  @default("pending")
  shipping_address Json?
  payment_method   String?
  coupon_id        BigInt?
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt
  deleted_at       DateTime?

  // relations
  user        User        @relation(fields: [user_id], references: [id])
  order_items OrderItem[]
  coupon      Coupon?     @relation(fields: [coupon_id], references: [id])
  payments    Payment[]

  @@map("orders")
}

model OrderItem {
  id          BigInt   @id @default(autoincrement())
  order_id    BigInt
  product_id  BigInt
  quantity    Int?     @default(1)
  unit_price  Decimal? @db.Decimal(10, 2)
  total_price Decimal? @db.Decimal(10, 2)
  color       String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  deleted_at  DateTime?

  // relations
  order   Order   @relation(fields: [order_id], references: [id])
  product Product @relation(fields: [product_id], references: [id])

  @@map("order_items")
}

model Review {
  id         BigInt   @id @default(autoincrement())
  user_id    BigInt
  product_id BigInt
  rating     Int?
  comment    String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  deleted_at DateTime?

  // relations
  user    User    @relation(fields: [user_id], references: [id])
  product Product @relation(fields: [product_id], references: [id])

  @@map("reviews")
}

model Wishlist {
  id         BigInt   @id @default(autoincrement())
  user_id    BigInt
  product_id BigInt
  created_at DateTime @default(now())
  deleted_at DateTime?

  // relations
  user    User    @relation(fields: [user_id], references: [id])
  product Product @relation(fields: [product_id], references: [id])

  @@unique([user_id, product_id])
  @@map("wishlists")
}

model Coupon {
  id             BigInt   @id @default(autoincrement())
  code           String   @unique
  description    String?
  discount_type  String   @default("percent")
  discount_value Decimal  @db.Decimal(10, 2)
  min_order      Decimal? @db.Decimal(10, 2)
  usage_limit    Int?     @default(1)
  used_count     Int?     @default(0)
  expires_at     DateTime?
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt
  deleted_at     DateTime?

  // relations
  orders Order[]
  users  User[] @relation("UserCoupons")

  @@map("coupons")
}

model FilterOption {
  id          BigInt   @id @default(autoincrement())
  key         String   // 'brand', 'ram', 'screen_size', etc.
  label       String   // Display name: 'Brand', 'RAM', etc.
  value       String   // Actual value: 'Apple', '8GB', etc.
  category_id BigInt?  // Optional: filter by category
  order       Int      @default(0) // Display order
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  deleted_at  DateTime?

  category Category? @relation(fields: [category_id], references: [id])

  @@unique([key, value, category_id])
  @@index([key, category_id])
  @@map("filter_options")
}

model Payment {
  id             BigInt    @id @default(autoincrement())
  order_id       BigInt
  provider       String    @default("momo")
  amount         Decimal   @db.Decimal(10, 2)
  currency       String    @default("VND")
  status         String    @default("pending") // pending, paid, failed, expired, canceled
  momo_order_id  String?   // orderId returned by MoMo
  momo_request_id String?  @unique // requestId used when creating payment
  momo_trans_id  String?   // transId returned after payment
  pay_url        String?
  deeplink       String?
  qr_code_url    String?
  signature      String?
  extra_data     String?
  result_code    Int?
  message        String?
  paid_at        DateTime?
  expired_at     DateTime?
  raw_response   Json?
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt
  deleted_at     DateTime?

  // relations
  order Order @relation(fields: [order_id], references: [id])

  @@index([order_id])
  @@map("payments")
}
